<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Reportes Acad√©micos</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --color-base: #F5F7FA;
            --color-primary: #007BFF;
            --color-secondary: #6C757D;
            --color-success: #28A745;
            --color-warning: #FFC107;
            --color-danger: #DC3545;
            --border-radius: 1rem;
            --box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.05);
            --padding: 1rem;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--color-base);
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1, h2, h3, h4 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        h1 {
            font-size: 2rem;
            color: var(--color-primary);
            text-align: center;
            margin-bottom: 2rem;
        }
        
        h2 {
            font-size: 1.5rem;
            color: var(--color-secondary);
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.5rem;
            margin-top: 2rem;
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: var(--padding);
            margin-bottom: 1.5rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        button, .btn {
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            display: inline-block;
            text-align: center;
        }
        
        button:hover, .btn:hover {
            background-color: #0056b3;
        }
        
        .btn-secondary {
            background-color: var(--color-secondary);
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-success {
            background-color: var(--color-success);
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-warning {
            background-color: var(--color-warning);
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .btn-danger {
            background-color: var(--color-danger);
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        input, select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 500;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .file-input {
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin-bottom: 1rem;
        }
        
        .file-input input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: var(--color-primary);
            color: white;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        
        .file-name {
            margin-left: 1rem;
            font-size: 0.9rem;
            color: var(--color-secondary);
        }
        
        .tab-container {
            margin-bottom: 2rem;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1rem;
        }
        
        .tab-button {
            padding: 0.75rem 1.5rem;
            background-color: #f8f9fa;
            border: none;
            border-radius: 0.5rem 0.5rem 0 0;
            margin-right: 0.5rem;
            cursor: pointer;
        }
        
        .tab-button.active {
            background-color: var(--color-primary);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .competence-table {
            margin-bottom: 1.5rem;
        }
        
        .competence-table th {
            background-color: #f8f9fa;
        }
        
        .checkbox-cell {
            text-align: center;
        }
        
        .report-preview {
            border: 1px solid #ddd;
            padding: 1.5rem;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }
        
        .student-info {
            margin-bottom: 1.5rem;
        }
        
        .evaluations-list {
            margin-bottom: 1.5rem;
        }
        
        .competence-status {
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .competence-approved {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--color-success);
        }
        
        .competence-not-approved {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--color-danger);
        }
        
        .recommendations {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .prediction {
            background-color: rgba(255, 193, 7, 0.1);
            padding: 1rem;
            border-radius: 0.5rem;
            color: #856404;
        }
        
        .group-report {
            margin-bottom: 1.5rem;
        }
        
        .group-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .group-message {
            font-style: italic;
            margin-bottom: 0.5rem;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--color-primary);
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--color-success);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .alert-danger {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--color-danger);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .alert-warning {
            background-color: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .weight-input {
            width: 60px;
            display: inline-block;
            margin-left: 0.5rem;
        }
        
        .weight-label {
            font-size: 0.9rem;
            color: var(--color-secondary);
        }
        
        .export-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .selection-section {
            margin-bottom: 1.5rem;
        }
        
        .selection-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .selection-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .selection-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .selection-checkbox {
            width: 1rem;
            height: 1rem;
        }
        
        .selection-label {
            font-size: 0.9rem;
        }
        
        .filter-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }
        
        .filter-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .filter-input {
            width: 80px;
        }
        
        .pdf-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .pdf-option {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .pdf-option label {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Generador de Reportes Acad√©micos</h1>
        
        <div class="card">
            <h2>Carga de Archivos</h2>
            <div class="grid">
                <div>
                    <h3>Archivo de Seguimiento Acad√©mico</h3>
                    <div class="file-input">
                        <label class="file-input-label">Seleccionar Archivo</label>
                        <input type="file" id="academicFile" accept=".xlsx, .xls">
                        <span class="file-name" id="academicFileName">No se ha seleccionado ning√∫n archivo</span>
                    </div>
                    <select id="academicSheetSelect" disabled>
                        <option value="">Seleccione una hoja...</option>
                    </select>
                    <button id="loadAcademicSheetBtn" class="btn-secondary" disabled>Cargar Hoja</button>
                </div>
                
                <div>
                    <h3>Archivo de Competencias</h3>
                    <div class="file-input">
                        <label class="file-input-label">Seleccionar Archivo</label>
                        <input type="file" id="competenceFile" accept=".xlsx, .xls">
                        <span class="file-name" id="competenceFileName">No se ha seleccionado ning√∫n archivo</span>
                    </div>
                    <select id="competenceSheetSelect" disabled>
                        <option value="">Seleccione una hoja...</option>
                    </select>
                    <button id="loadCompetenceSheetBtn" class="btn-secondary" disabled>Cargar Hoja</button>
                </div>
            </div>
        </div>
        
        <div id="associationSection" class="card hidden">
            <h2>Selecci√≥n y Asociaci√≥n</h2>
            <div id="associationAlert" class="alert alert-warning hidden">
                Por favor, cargue ambos archivos y seleccione las hojas correspondientes antes de continuar.
            </div>
            
            <div id="evaluationSelectionSection" class="selection-section hidden">
                <h3>Seleccione las evaluaciones a procesar</h3>
                <div class="selection-options" id="evaluationSelectionOptions"></div>
                <button id="confirmEvaluationsBtn" class="btn" style="margin-top: 1rem;">Confirmar Evaluaciones</button>
            </div>
            
            <div id="competenceSelectionSection" class="selection-section hidden">
                <h3>Seleccione las competencias a considerar</h3>
                <div class="selection-options" id="competenceSelectionOptions"></div>
                <button id="confirmCompetencesBtn" class="btn" style="margin-top: 1rem;">Confirmar Competencias</button>
            </div>
            
            <div id="evaluationTableContainer" class="hidden">
                <h3>Evaluaciones Seleccionadas</h3>
                <table class="competence-table">
                    <thead>
                        <tr>
                            <th>ID Evaluaci√≥n</th>
                            <th>Nombre Evaluaci√≥n</th>
                            <th>Peso (%)</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="evaluationTableBody"></tbody>
                </table>
            </div>
            
            <div id="competenceAssociationModal" class="modal hidden">
                <div class="card" style="max-width: 800px; margin: 2rem auto;">
                    <h3>Asociar Competencias a: <span id="currentEvaluationName"></span></h3>
                    <div class="weight-label">
                        Ponderaci√≥n actual: <span id="currentWeight">0</span>%
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <h4>Criterios de Evaluaci√≥n</h4>
                        <div class="selection-options" id="criteriaSelectionOptions"></div>
                    </div>
                    
                    <div class="export-buttons">
                        <button id="saveAssociationBtn" class="btn-success">Guardar Asociaciones</button>
                        <button id="cancelAssociationBtn" class="btn-secondary">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="reportSection" class="card hidden">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="individualReport">Reporte Individual</button>
                    <button class="tab-button" data-tab="groupReport">Reporte Grupal</button>
                </div>
                
                <div id="individualReport" class="tab-content active">
                    <h2>Reporte Individual</h2>
                    <select id="studentSelect">
                        <option value="">Seleccione un estudiante...</option>
                    </select>
                    
                    <div id="individualReportPreview" class="report-preview hidden">
                        <div class="student-info">
                            <h3 id="studentName"></h3>
                            <p>ID: <span id="studentId"></span></p>
                        </div>
                        
                        <div class="evaluations-list">
                            <h4>Evaluaciones</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Evaluaci√≥n</th>
                                        <th>Nota</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="evaluationsListBody"></tbody>
                            </table>
                        </div>
                        
                        <div id="competencesStatus">
                            <h4>Estado de Competencias</h4>
                            <div id="competencesList"></div>
                        </div>
                        
                        <div id="recommendationsSection" class="recommendations hidden">
                            <h4>Recomendaciones</h4>
                            <ul id="recommendationsList"></ul>
                        </div>
                        
                        <div id="predictionSection" class="prediction hidden">
                            <h4>Predicci√≥n de Aprobaci√≥n</h4>
                            <p id="predictionText"></p>
                        </div>
                    </div>
                    
                    <div class="export-buttons">
                        <button id="generateIndividualReportBtn" class="btn" disabled>Generar Reporte</button>
                        <button id="exportIndividualPdfBtn" class="btn-secondary" disabled>Exportar a PDF</button>
                    </div>
                </div>
                
                <div id="groupReport" class="tab-content">
                    <h2>Reporte Grupal</h2>
                    
                    <div class="filter-section">
                        <h3>Filtros de Notas</h3>
                        <div class="filter-row">
                            <div class="filter-group">
                                <input type="radio" id="filterAll" name="filterType" value="all" checked>
                                <label for="filterAll">Todos los estudiantes</label>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <input type="radio" id="filterRange" name="filterType" value="range">
                                <label for="filterRange">Nota entre</label>
                                <input type="number" id="filterMin" class="filter-input" min="0" max="5" step="0.1" disabled>
                                <label>y</label>
                                <input type="number" id="filterMax" class="filter-input" min="0" max="5" step="0.1" disabled>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <input type="radio" id="filterGreater" name="filterType" value="greater">
                                <label for="filterGreater">Nota mayor o igual a</label>
                                <input type="number" id="filterGreaterValue" class="filter-input" min="0" max="5" step="0.1" disabled>
                            </div>
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <input type="radio" id="filterLess" name="filterType" value="less">
                                <label for="filterLess">Nota menor o igual a</label>
                                <input type="number" id="filterLessValue" class="filter-input" min="0" max="5" step="0.1" disabled>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pdf-options">
                        <div class="pdf-option">
                            <label for="pageSize">Tama√±o de p√°gina:</label>
                            <select id="pageSize">
                                <option value="letter">Carta (21.6 x 27.9 cm)</option>
                                <option value="legal">Oficio (21.6 x 35.6 cm)</option>
                            </select>
                        </div>
                        
                        <div class="pdf-option">
                            <label for="pageOrientation">Orientaci√≥n:</label>
                            <select id="pageOrientation">
                                <option value="portrait">Vertical</option>
                                <option value="landscape">Horizontal</option>
                            </select>
                        </div>
                    </div>
                    
                    <button id="generateGroupReportBtn" class="btn">Generar Reporte Grupal</button>
                    
                    <div id="groupReportPreview" class="report-preview hidden">
                        <div id="groupReportContent"></div>
                    </div>
                    
                    <div class="export-buttons">
                        <button id="exportGroupPdfBtn" class="btn-secondary" disabled>Exportar a PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let academicData = null;
        let competenceData = null;
        let students = [];
        let allEvaluations = [];
        let selectedEvaluations = [];
        let allCompetences = [];
        let selectedCompetences = [];
        let associations = {};
        let currentEvaluationId = null;
        
        // Elementos del DOM
        const academicFileInput = document.getElementById('academicFile');
        const academicFileName = document.getElementById('academicFileName');
        const academicSheetSelect = document.getElementById('academicSheetSelect');
        const loadAcademicSheetBtn = document.getElementById('loadAcademicSheetBtn');
        
        const competenceFileInput = document.getElementById('competenceFile');
        const competenceFileName = document.getElementById('competenceFileName');
        const competenceSheetSelect = document.getElementById('competenceSheetSelect');
        const loadCompetenceSheetBtn = document.getElementById('loadCompetenceSheetBtn');
        
        const associationSection = document.getElementById('associationSection');
        const associationAlert = document.getElementById('associationAlert');
        const evaluationSelectionSection = document.getElementById('evaluationSelectionSection');
        const evaluationSelectionOptions = document.getElementById('evaluationSelectionOptions');
        const confirmEvaluationsBtn = document.getElementById('confirmEvaluationsBtn');
        const competenceSelectionSection = document.getElementById('competenceSelectionSection');
        const competenceSelectionOptions = document.getElementById('competenceSelectionOptions');
        const confirmCompetencesBtn = document.getElementById('confirmCompetencesBtn');
        const evaluationTableContainer = document.getElementById('evaluationTableContainer');
        const evaluationTableBody = document.getElementById('evaluationTableBody');
        
        const competenceAssociationModal = document.getElementById('competenceAssociationModal');
        const currentEvaluationName = document.getElementById('currentEvaluationName');
        const currentWeight = document.getElementById('currentWeight');
        const criteriaSelectionOptions = document.getElementById('criteriaSelectionOptions');
        const saveAssociationBtn = document.getElementById('saveAssociationBtn');
        const cancelAssociationBtn = document.getElementById('cancelAssociationBtn');
        
        const reportSection = document.getElementById('reportSection');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        const studentSelect = document.getElementById('studentSelect');
        const individualReportPreview = document.getElementById('individualReportPreview');
        const studentName = document.getElementById('studentName');
        const studentId = document.getElementById('studentId');
        const evaluationsListBody = document.getElementById('evaluationsListBody');
        const competencesList = document.getElementById('competencesList');
        const recommendationsSection = document.getElementById('recommendationsSection');
        const recommendationsList = document.getElementById('recommendationsList');
        const predictionSection = document.getElementById('predictionSection');
        const predictionText = document.getElementById('predictionText');
        const generateIndividualReportBtn = document.getElementById('generateIndividualReportBtn');
        const exportIndividualPdfBtn = document.getElementById('exportIndividualPdfBtn');
        
        const filterAll = document.getElementById('filterAll');
        const filterRange = document.getElementById('filterRange');
        const filterMin = document.getElementById('filterMin');
        const filterMax = document.getElementById('filterMax');
        const filterGreater = document.getElementById('filterGreater');
        const filterGreaterValue = document.getElementById('filterGreaterValue');
        const filterLess = document.getElementById('filterLess');
        const filterLessValue = document.getElementById('filterLessValue');
        const pageSize = document.getElementById('pageSize');
        const pageOrientation = document.getElementById('pageOrientation');
        const generateGroupReportBtn = document.getElementById('generateGroupReportBtn');
        const groupReportPreview = document.getElementById('groupReportPreview');
        const groupReportContent = document.getElementById('groupReportContent');
        const exportGroupPdfBtn = document.getElementById('exportGroupPdfBtn');
        
        // Event Listeners
        academicFileInput.addEventListener('change', handleAcademicFileSelect);
        loadAcademicSheetBtn.addEventListener('click', loadAcademicSheet);
        
        competenceFileInput.addEventListener('change', handleCompetenceFileSelect);
        loadCompetenceSheetBtn.addEventListener('click', loadCompetenceSheet);
        
        confirmEvaluationsBtn.addEventListener('click', confirmEvaluationsSelection);
        confirmCompetencesBtn.addEventListener('click', confirmCompetencesSelection);
        
        tabButtons.forEach(button => {
            button.addEventListener('click', switchTab);
        });
        
        studentSelect.addEventListener('change', generateIndividualReport);
        generateIndividualReportBtn.addEventListener('click', generateIndividualReport);
        exportIndividualPdfBtn.addEventListener('click', exportIndividualToPdf);
        
        // Habilitar/deshabilitar campos de filtro seg√∫n selecci√≥n
        filterAll.addEventListener('change', () => {
            filterMin.disabled = true;
            filterMax.disabled = true;
            filterGreaterValue.disabled = true;
            filterLessValue.disabled = true;
        });
        
        filterRange.addEventListener('change', () => {
            filterMin.disabled = false;
            filterMax.disabled = false;
            filterGreaterValue.disabled = true;
            filterLessValue.disabled = true;
        });
        
        filterGreater.addEventListener('change', () => {
            filterMin.disabled = true;
            filterMax.disabled = true;
            filterGreaterValue.disabled = false;
            filterLessValue.disabled = true;
        });
        
        filterLess.addEventListener('change', () => {
            filterMin.disabled = true;
            filterMax.disabled = true;
            filterGreaterValue.disabled = true;
            filterLessValue.disabled = false;
        });
        
        generateGroupReportBtn.addEventListener('click', generateGroupReport);
        exportGroupPdfBtn.addEventListener('click', exportGroupToPdf);
        
        saveAssociationBtn.addEventListener('click', saveAssociations);
        cancelAssociationBtn.addEventListener('click', cancelAssociation);
        
        // Funciones para manejar archivos
        function handleAcademicFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                academicFileName.textContent = file.name;
                parseExcelFile(file, academicSheetSelect, true);
                loadAcademicSheetBtn.disabled = false;
            }
        }
        
        function handleCompetenceFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                competenceFileName.textContent = file.name;
                parseExcelFile(file, competenceSheetSelect, false);
                loadCompetenceSheetBtn.disabled = false;
            }
        }
        
        function parseExcelFile(file, sheetSelect, isAcademic) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Limpiar select
                    sheetSelect.innerHTML = '<option value="">Seleccione una hoja...</option>';
                    
                    // Agregar opciones para cada hoja
                    workbook.SheetNames.forEach(sheetName => {
                        const option = document.createElement('option');
                        option.value = sheetName;
                        option.textContent = sheetName;
                        sheetSelect.appendChild(option);
                    });
                    
                    sheetSelect.disabled = false;
                } catch (error) {
                    console.error('Error al procesar el archivo:', error);
                    alert('Error al procesar el archivo. Aseg√∫rese de que es un archivo Excel v√°lido.');
                }
            };
            
            reader.onerror = function() {
                console.error('Error al leer el archivo');
                alert('Error al leer el archivo. Intente nuevamente.');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function loadAcademicSheet() {
            const sheetName = academicSheetSelect.value;
            if (!sheetName) return;
            
            const file = academicFileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Convertir a JSON usando header: 1 para obtener arrays
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    academicData = jsonData;
                    
                    // Procesar datos acad√©micos
                    processAcademicData();
                    checkDataLoaded();
                } catch (error) {
                    console.error('Error al cargar la hoja acad√©mica:', error);
                    alert('Error al procesar la hoja acad√©mica. Verifique el formato.');
                }
            };
            
            reader.onerror = function() {
                console.error('Error al leer el archivo acad√©mico');
                alert('Error al leer el archivo acad√©mico. Intente nuevamente.');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function loadCompetenceSheet() {
            const sheetName = competenceSheetSelect.value;
            if (!sheetName) return;
            
            const file = competenceFileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Convertir a JSON usando header: 1 para obtener arrays
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    competenceData = jsonData;
                    
                    // Procesar datos de competencias
                    processCompetenceData();
                    checkDataLoaded();
                } catch (error) {
                    console.error('Error al cargar la hoja de competencias:', error);
                    alert('Error al procesar la hoja de competencias. Verifique el formato.');
                }
            };
            
            reader.onerror = function() {
                console.error('Error al leer el archivo de competencias');
                alert('Error al leer el archivo de competencias. Intente nuevamente.');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function processAcademicData() {
            if (!academicData || academicData.length < 2) {
                console.error('Datos acad√©micos vac√≠os o insuficientes');
                return;
            }
            
            // Obtener encabezados (primera fila)
            const headers = academicData[0];
            
            // Buscar columnas importantes (case insensitive)
            const idIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('id'));
            const nameIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('nombre'));
            
            if (idIndex === -1 || nameIndex === -1) {
                console.error('No se encontraron columnas de ID o Nombre');
                alert('El archivo debe contener columnas de ID y Nombre del estudiante');
                return;
            }
            
            // Identificar columnas de evaluaciones (asumimos que son las que no son ID ni Nombre)
            const evaluationColumns = headers.filter((h, i) => 
                i !== idIndex && i !== nameIndex && h && h.toString().trim() !== ''
            );
            
            if (evaluationColumns.length === 0) {
                console.error('No se encontraron columnas de evaluaciones');
                alert('El archivo debe contener al menos una columna de evaluaci√≥n');
                return;
            }
            
            // Procesar estudiantes
            students = [];
            for (let i = 1; i < academicData.length; i++) {
                const row = academicData[i];
                if (!row || row.length === 0) continue;
                
                const student = {
                    id: row[idIndex]?.toString() || '',
                    name: row[nameIndex]?.toString() || '',
                    evaluations: {}
                };
                
                evaluationColumns.forEach(evalName => {
                    const headerIndex = headers.indexOf(evalName);
                    if (headerIndex !== -1 && row[headerIndex] !== undefined) {
                        // Convertir a n√∫mero, si no es v√°lido, usar 0
                        const score = parseFloat(row[headerIndex]);
                        student.evaluations[evalName] = isNaN(score) ? 0 : score;
                    }
                });
                
                if (student.id && student.name) {
                    students.push(student);
                }
            }
            
            if (students.length === 0) {
                console.error('No se encontraron estudiantes v√°lidos');
                alert('No se encontraron estudiantes v√°lidos en el archivo');
                return;
            }
            
            // Procesar todas las evaluaciones disponibles
            allEvaluations = evaluationColumns.map(evalName => {
                return {
                    id: evalName,
                    name: evalName,
                    weight: 0, // Se calcular√° m√°s adelante
                    competences: [], // Se llenar√° con las asociaciones
                    selected: true // Por defecto todas seleccionadas
                };
            });
            
            // Mostrar opciones de selecci√≥n de evaluaciones
            showEvaluationSelectionOptions();
        }
        
        function processCompetenceData() {
            if (!competenceData || competenceData.length < 2) {
                console.error('Datos de competencias vac√≠os o insuficientes');
                return;
            }
            
            // Obtener encabezados (primera fila)
            const headers = competenceData[0];
            
            // Buscar columnas importantes (case insensitive)
            const competenceIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('competencia'));
            const criteriaIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('criterio'));
            
            if (competenceIndex === -1 || criteriaIndex === -1) {
                console.error('No se encontraron columnas de Competencia o Criterio');
                alert('El archivo de competencias debe contener columnas de Competencia y Criterio');
                return;
            }
            
            // Procesar competencias y criterios
            allCompetences = [];
            let currentCompetence = null;
            
            for (let i = 1; i < competenceData.length; i++) {
                const row = competenceData[i];
                if (!row || row.length === 0) continue;
                
                const competenceName = row[competenceIndex]?.toString().trim();
                const criteriaName = row[criteriaIndex]?.toString().trim();
                
                if (competenceName && competenceName !== '') {
                    // Nueva competencia
                    currentCompetence = {
                        id: competenceName,
                        name: competenceName,
                        criteria: [],
                        selected: true // Por defecto todas seleccionadas
                    };
                    allCompetences.push(currentCompetence);
                }
                
                if (currentCompetence && criteriaName && criteriaName !== '') {
                    currentCompetence.criteria.push({
                        id: criteriaName,
                        name: criteriaName,
                        selected: true // Por defecto todos seleccionados
                    });
                }
            }
            
            if (allCompetences.length === 0) {
                console.error('No se encontraron competencias v√°lidas');
                alert('No se encontraron competencias v√°lidas en el archivo');
                return;
            }
            
            // Mostrar opciones de selecci√≥n de competencias
            showCompetenceSelectionOptions();
        }
        
        function showEvaluationSelectionOptions() {
            evaluationSelectionOptions.innerHTML = '';
            
            allEvaluations.forEach(evaluation => {
                const item = document.createElement('div');
                item.className = 'selection-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'selection-checkbox';
                checkbox.checked = evaluation.selected;
                checkbox.id = `eval-${evaluation.id}`;
                checkbox.addEventListener('change', (e) => {
                    evaluation.selected = e.target.checked;
                });
                
                const label = document.createElement('label');
                label.className = 'selection-label';
                label.htmlFor = `eval-${evaluation.id}`;
                label.textContent = evaluation.name;
                
                item.appendChild(checkbox);
                item.appendChild(label);
                evaluationSelectionOptions.appendChild(item);
            });
            
            evaluationSelectionSection.classList.remove('hidden');
        }
        
        function showCompetenceSelectionOptions() {
            competenceSelectionOptions.innerHTML = '';
            
            allCompetences.forEach(competence => {
                const item = document.createElement('div');
                item.className = 'selection-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'selection-checkbox';
                checkbox.checked = competence.selected;
                checkbox.id = `comp-${competence.id}`;
                checkbox.addEventListener('change', (e) => {
                    competence.selected = e.target.checked;
                });
                
                const label = document.createElement('label');
                label.className = 'selection-label';
                label.htmlFor = `comp-${competence.id}`;
                label.textContent = competence.name;
                
                item.appendChild(checkbox);
                item.appendChild(label);
                competenceSelectionOptions.appendChild(item);
            });
            
            competenceSelectionSection.classList.remove('hidden');
        }
        
        function confirmEvaluationsSelection() {
            selectedEvaluations = allEvaluations.filter(eval => eval.selected);
            
            if (selectedEvaluations.length === 0) {
                alert('Debe seleccionar al menos una evaluaci√≥n');
                return;
            }
            
            // Calcular pesos iniciales (iguales para todas las evaluaciones seleccionadas)
            const initialWeight = (100 / selectedEvaluations.length).toFixed(2);
            selectedEvaluations.forEach(eval => {
                eval.weight = parseFloat(initialWeight);
            });
            
            evaluationSelectionSection.classList.add('hidden');
            
            // Si ya se seleccionaron competencias, mostrar la tabla de evaluaciones
            if (selectedCompetences.length > 0) {
                showEvaluationsTable();
            }
        }
        
        function confirmCompetencesSelection() {
            selectedCompetences = allCompetences.filter(comp => comp.selected);
            
            if (selectedCompetences.length === 0) {
                alert('Debe seleccionar al menos una competencia');
                return;
            }
            
            competenceSelectionSection.classList.add('hidden');
            
            // Si ya se seleccionaron evaluaciones, mostrar la tabla de evaluaciones
            if (selectedEvaluations.length > 0) {
                showEvaluationsTable();
            }
        }
        
        function checkDataLoaded() {
            if (academicData && competenceData && students.length > 0 && allCompetences.length > 0) {
                associationSection.classList.remove('hidden');
                associationAlert.classList.add('hidden');
            } else {
                associationAlert.classList.remove('hidden');
            }
        }
        
        function showEvaluationsTable() {
            evaluationTableContainer.classList.remove('hidden');
            reportSection.classList.remove('hidden');
            
            // Mostrar tabla de evaluaciones
            displayEvaluationsTable();
            
            // Llenar select de estudiantes
            fillStudentSelect();
        }
        
        function fillStudentSelect() {
            studentSelect.innerHTML = '<option value="">Seleccione un estudiante...</option>';
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.id})`;
                studentSelect.appendChild(option);
            });
            
            generateIndividualReportBtn.disabled = students.length === 0;
        }
        
        function displayEvaluationsTable() {
            evaluationTableBody.innerHTML = '';
            
            selectedEvaluations.forEach(evaluation => {
                const row = document.createElement('tr');
                
                // ID Evaluaci√≥n
                const idCell = document.createElement('td');
                idCell.textContent = evaluation.id;
                row.appendChild(idCell);
                
                // Nombre Evaluaci√≥n
                const nameCell = document.createElement('td');
                nameCell.textContent = evaluation.name;
                row.appendChild(nameCell);
                
                // Peso
                const weightCell = document.createElement('td');
                const weightInput = document.createElement('input');
                weightInput.type = 'number';
                weightInput.className = 'weight-input';
                weightInput.value = evaluation.weight.toFixed(2);
                weightInput.min = '0';
                weightInput.max = '100';
                weightInput.step = '0.01';
                weightInput.addEventListener('change', (e) => {
                    const newWeight = parseFloat(e.target.value);
                    if (!isNaN(newWeight)) {
                        evaluation.weight = newWeight;
                    }
                });
                weightCell.appendChild(weightInput);
                row.appendChild(weightCell);
                
                // Acciones
                const actionsCell = document.createElement('td');
                const associateBtn = document.createElement('button');
                associateBtn.className = 'btn';
                associateBtn.textContent = 'Asociar Competencias';
                associateBtn.addEventListener('click', () => openAssociationModal(evaluation.id));
                actionsCell.appendChild(associateBtn);
                row.appendChild(actionsCell);
                
                evaluationTableBody.appendChild(row);
            });
        }
        
        function openAssociationModal(evaluationId) {
            currentEvaluationId = evaluationId;
            const evaluation = selectedEvaluations.find(e => e.id === evaluationId);
            
            if (!evaluation) return;
            
            currentEvaluationName.textContent = evaluation.name;
            currentWeight.textContent = evaluation.weight.toFixed(2);
            
            // Limpiar opciones de criterios
            criteriaSelectionOptions.innerHTML = '';
            
            // Llenar con criterios de las competencias seleccionadas
            selectedCompetences.forEach(competence => {
                // T√≠tulo de la competencia
                const competenceTitle = document.createElement('div');
                competenceTitle.className = 'selection-title';
                competenceTitle.textContent = competence.name;
                criteriaSelectionOptions.appendChild(competenceTitle);
                
                // Criterios de la competencia
                competence.criteria.forEach(criteria => {
                    const item = document.createElement('div');
                    item.className = 'selection-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'selection-checkbox';
                    checkbox.checked = criteria.selected;
                    checkbox.id = `criteria-${criteria.id}`;
                    checkbox.addEventListener('change', (e) => {
                        criteria.selected = e.target.checked;
                    });
                    
                    const label = document.createElement('label');
                    label.className = 'selection-label';
                    label.htmlFor = `criteria-${criteria.id}`;
                    label.textContent = criteria.name;
                    
                    item.appendChild(checkbox);
                    item.appendChild(label);
                    criteriaSelectionOptions.appendChild(item);
                });
            });
            
            competenceAssociationModal.classList.remove('hidden');
        }
        
        function saveAssociations() {
            const evaluation = selectedEvaluations.find(e => e.id === currentEvaluationId);
            if (!evaluation) return;
            
            // Limpiar competencias existentes
            evaluation.competences = [];
            
            // Obtener competencias y criterios seleccionados
            selectedCompetences.forEach(competence => {
                const selectedCriteria = competence.criteria.filter(c => c.selected);
                
                if (selectedCriteria.length > 0) {
                    evaluation.competences.push({
                        id: competence.id,
                        name: competence.name,
                        criteria: selectedCriteria.map(c => ({
                            id: c.id,
                            name: c.name
                        }))
                    });
                }
            });
            
            // Guardar asociaci√≥n global
            associations[currentEvaluationId] = evaluation.competences;
            
            // Cerrar modal
            competenceAssociationModal.classList.add('hidden');
        }
        
        function cancelAssociation() {
            competenceAssociationModal.classList.add('hidden');
        }
        
        function switchTab(event) {
            const tabId = event.target.getAttribute('data-tab');
            
            // Actualizar botones de pesta√±a
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Actualizar contenido de pesta√±a
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }
        
        function generateIndividualReport() {
            const studentId = studentSelect.value;
            if (!studentId) return;
            
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Mostrar informaci√≥n del estudiante
            studentName.textContent = student.name;
            studentId.textContent = student.id;
            
            // Mostrar evaluaciones
            evaluationsListBody.innerHTML = '';
            
            let totalWeightedScore = 0;
            let totalWeight = 0;
            
            selectedEvaluations.forEach(evaluation => {
                const score = student.evaluations[evaluation.id] || 0;
                const weightedScore = score * (evaluation.weight / 100);
                
                totalWeightedScore += weightedScore;
                totalWeight += evaluation.weight;
                
                const row = document.createElement('tr');
                
                // Nombre evaluaci√≥n
                const nameCell = document.createElement('td');
                nameCell.textContent = evaluation.name;
                row.appendChild(nameCell);
                
                // Nota
                const scoreCell = document.createElement('td');
                scoreCell.textContent = score.toFixed(2);
                row.appendChild(scoreCell);
                
                // Estado
                const statusCell = document.createElement('td');
                if (score >= 3.0) {
                    statusCell.innerHTML = '<span style="color: var(--color-success)">Aprobado</span>';
                } else {
                    statusCell.innerHTML = '<span style="color: var(--color-danger)">No aprobado</span>';
                }
                row.appendChild(statusCell);
                
                evaluationsListBody.appendChild(row);
            });
            
            // Mostrar competencias
            competencesList.innerHTML = '';
            
            let hasNotApprovedCompetences = false;
            const studentCompetences = {};
            
            // Calcular estado de cada competencia seleccionada
            selectedCompetences.forEach(competence => {
                // Verificar si esta competencia est√° asociada a alguna evaluaci√≥n
                const isAssociated = selectedEvaluations.some(eval => 
                    eval.competences.some(comp => comp.id === competence.id)
                );
                
                if (!isAssociated) return; // Saltar competencias no asociadas
                
                // Calcular promedio ponderado para esta competencia
                let competenceScore = 0;
                let competenceWeight = 0;
                
                selectedEvaluations.forEach(evaluation => {
                    const isInEvaluation = evaluation.competences.some(comp => comp.id === competence.id);
                    if (isInEvaluation) {
                        const score = student.evaluations[evaluation.id] || 0;
                        competenceScore += score * (evaluation.weight / 100);
                        competenceWeight += evaluation.weight;
                    }
                });
                
                const finalScore = competenceWeight > 0 ? (competenceScore / (competenceWeight / 100)) : 0;
                const isApproved = finalScore >= 3.0;
                
                if (!isApproved) {
                    hasNotApprovedCompetences = true;
                }
                
                studentCompetences[competence.id] = {
                    score: finalScore,
                    isApproved: isApproved
                };
                
                // Mostrar estado de la competencia
                const competenceDiv = document.createElement('div');
                competenceDiv.className = isApproved ? 'competence-status competence-approved' : 'competence-status competence-not-approved';
                
                const competenceTitle = document.createElement('strong');
                competenceTitle.textContent = competence.name;
                competenceDiv.appendChild(competenceTitle);
                
                const competenceScoreText = document.createElement('p');
                competenceScoreText.textContent = `Calificaci√≥n: ${finalScore.toFixed(2)} - ${isApproved ? 'Aprobada' : 'No aprobada'}`;
                competenceDiv.appendChild(competenceScoreText);
                
                competencesList.appendChild(competenceDiv);
            });
            
            // Mostrar recomendaciones si hay competencias no aprobadas
            if (hasNotApprovedCompetences) {
                recommendationsSection.classList.remove('hidden');
                recommendationsList.innerHTML = '';
                
                // Generar recomendaciones
                const recommendations = [
                    'Asiste regularmente a clase',
                    'Aprovecha las asesor√≠as',
                    'Realiza todas las actividades',
                    'Repasa los temas con dificultad',
                    'Participa activamente en clase'
                ];
                
                recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.textContent = rec;
                    recommendationsList.appendChild(li);
                });
                
                // Generar frase de est√≠mulo
                const encouragementPhrases = [
                    '¬°Vas por buen camino, no te detengas!',
                    'Todos los esfuerzos tienen su recompensa, sigue adelante.',
                    'Cada error es una oportunidad para aprender.',
                    'La pr√°ctica hace al maestro, sigue trabajando.',
                    'T√∫ puedes lograrlo, solo necesitas un poco m√°s de esfuerzo.'
                ];
                
                const randomPhrase = encouragementPhrases[Math.floor(Math.random() * encouragementPhrases.length)];
                const encouragementP = document.createElement('p');
                encouragementP.innerHTML = `‚úÖ <strong>Frase de est√≠mulo:</strong> ${randomPhrase}`;
                recommendationsSection.insertBefore(encouragementP, recommendationsList);
            } else {
                recommendationsSection.classList.add('hidden');
            }
            
            // Calcular predicci√≥n si el promedio es menor a 3.0
            const finalScore = totalWeight > 0 ? (totalWeightedScore / (totalWeight / 100)) : 0;
            
            if (finalScore < 3.0) {
                predictionSection.classList.remove('hidden');
                
                // Calcular nota m√≠nima necesaria en la pr√≥xima evaluaci√≥n para aprobar
                // Asumimos que hay una evaluaci√≥n futura con un peso promedio
                const averageWeight = selectedEvaluations.reduce((sum, eval) => sum + eval.weight, 0) / selectedEvaluations.length;
                const neededScore = (3.0 * 100 - finalScore * (100 - averageWeight)) / averageWeight;
                
                predictionText.textContent = `Nota actual: ${finalScore.toFixed(2)}. `;
                predictionText.textContent += `Necesita al menos ${Math.max(neededScore, 3.0).toFixed(2)} en la pr√≥xima evaluaci√≥n (con peso ${averageWeight.toFixed(2)}%) para aprobar el curso.`;
            } else {
                predictionSection.classList.add('hidden');
            }
            
            // Mostrar reporte
            individualReportPreview.classList.remove('hidden');
            exportIndividualPdfBtn.disabled = false;
        }
        
        function generateGroupReport() {
            groupReportContent.innerHTML = '';
            
            // Calcular promedios de todos los estudiantes
            students.forEach(student => {
                let totalWeightedScore = 0;
                let totalWeight = 0;
                
                selectedEvaluations.forEach(evaluation => {
                    const score = student.evaluations[evaluation.id] || 0;
                    totalWeightedScore += score * (evaluation.weight / 100);
                    totalWeight += evaluation.weight;
                });
                
                student.finalScore = totalWeight > 0 ? (totalWeightedScore / (totalWeight / 100)) : 0;
            });
            
            // Filtrar estudiantes seg√∫n criterios seleccionados
            let filteredStudents = [...students];
            
            if (filterRange.checked) {
                const min = parseFloat(filterMin.value) || 0;
                const max = parseFloat(filterMax.value) || 5;
                filteredStudents = filteredStudents.filter(student => 
                    student.finalScore >= min && student.finalScore <= max
                );
            } else if (filterGreater.checked) {
                const value = parseFloat(filterGreaterValue.value) || 0;
                filteredStudents = filteredStudents.filter(student => 
                    student.finalScore >= value
                );
            } else if (filterLess.checked) {
                const value = parseFloat(filterLessValue.value) || 0;
                filteredStudents = filteredStudents.filter(student => 
                    student.finalScore <= value
                );
            }
            
            if (filteredStudents.length === 0) {
                groupReportContent.innerHTML = '<p>No hay estudiantes que cumplan con los criterios de filtrado seleccionados.</p>';
                groupReportPreview.classList.remove('hidden');
                exportGroupPdfBtn.disabled = true;
                return;
            }
            
            // Ordenar estudiantes por nota (de mayor a menor)
            filteredStudents.sort((a, b) => b.finalScore - a.finalScore);
            
            // Generar tabla de resultados
            const table = document.createElement('table');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>#</th><th>Nombre</th><th>ID</th><th>Promedio</th><th>Estado</th>';
            table.appendChild(headerRow);
            
            filteredStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                
                // N√∫mero
                const numberCell = document.createElement('td');
                numberCell.textContent = index + 1;
                row.appendChild(numberCell);
                
                // Nombre
                const nameCell = document.createElement('td');
                nameCell.textContent = student.name;
                row.appendChild(nameCell);
                
                // ID
                const idCell = document.createElement('td');
                idCell.textContent = student.id;
                row.appendChild(idCell);
                
                // Promedio
                const scoreCell = document.createElement('td');
                scoreCell.textContent = student.finalScore.toFixed(2);
                row.appendChild(scoreCell);
                
                // Estado
                const statusCell = document.createElement('td');
                if (student.finalScore >= 3.0) {
                    statusCell.innerHTML = '<span style="color: var(--color-success)">Aprobado</span>';
                } else {
                    statusCell.innerHTML = '<span style="color: var(--color-danger)">No aprobado</span>';
                }
                row.appendChild(statusCell);
                
                table.appendChild(row);
            });
            
            // Estad√≠sticas resumen
            const statsDiv = document.createElement('div');
            statsDiv.className = 'group-report';
            
            const statsTitle = document.createElement('h3');
            statsTitle.className = 'group-title';
            statsTitle.textContent = 'Resumen Estad√≠stico';
            statsDiv.appendChild(statsTitle);
            
            const count = filteredStudents.length;
            const approved = filteredStudents.filter(s => s.finalScore >= 3.0).length;
            const notApproved = count - approved;
            const average = filteredStudents.reduce((sum, s) => sum + s.finalScore, 0) / count;
            const maxScore = Math.max(...filteredStudents.map(s => s.finalScore));
            const minScore = Math.min(...filteredStudents.map(s => s.finalScore));
            
            const statsList = document.createElement('ul');
            statsList.style.listStyleType = 'none';
            statsList.style.paddingLeft = '0';
            
            const items = [
                `Total estudiantes: ${count}`,
                `Aprobados: ${approved} (${((approved / count) * 100).toFixed(1)}%)`,
                `No aprobados: ${notApproved} (${((notApproved / count) * 100).toFixed(1)}%)`,
                `Promedio general: ${average.toFixed(2)}`,
                `Nota m√°xima: ${maxScore.toFixed(2)}`,
                `Nota m√≠nima: ${minScore.toFixed(2)}`
            ];
            
            items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                li.style.marginBottom = '0.5rem';
                statsList.appendChild(li);
            });
            
            statsDiv.appendChild(statsList);
            groupReportContent.appendChild(statsDiv);
            groupReportContent.appendChild(table);
            
            // Mostrar reporte
            groupReportPreview.classList.remove('hidden');
            exportGroupPdfBtn.disabled = false;
        }
        
        function exportIndividualToPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // T√≠tulo
            doc.setFontSize(18);
            doc.setTextColor(0, 123, 255);
            doc.text('Reporte Acad√©mico Individual', 105, 20, { align: 'center' });
            
            // Informaci√≥n del estudiante
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Estudiante: ${studentName.textContent}`, 20, 40);
            doc.text(`ID: ${studentId.textContent}`, 20, 50);
            
            // Evaluaciones
            doc.setFontSize(14);
            doc.text('Evaluaciones:', 20, 70);
            
            let y = 80;
            doc.setFontSize(10);
            doc.text('Evaluaci√≥n', 20, y);
            doc.text('Nota', 100, y);
            doc.text('Estado', 150, y);
            y += 10;
            
            const rows = evaluationsListBody.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                doc.text(cells[0].textContent, 20, y);
                doc.text(cells[1].textContent, 100, y);
                
                if (cells[2].textContent.includes('Aprobado')) {
                    doc.setTextColor(40, 167, 69);
                } else {
                    doc.setTextColor(220, 53, 69);
                }
                
                doc.text(cells[2].textContent, 150, y);
                doc.setTextColor(0, 0, 0);
                y += 10;
            });
            
            // Competencias
            y += 10;
            doc.setFontSize(14);
            doc.text('Estado de Competencias:', 20, y);
            y += 10;
            
            const competenceDivs = competencesList.querySelectorAll('.competence-status');
            competenceDivs.forEach(div => {
                const title = div.querySelector('strong').textContent;
                const text = div.querySelector('p').textContent;
                
                if (div.classList.contains('competence-approved')) {
                    doc.setTextColor(40, 167, 69);
                } else {
                    doc.setTextColor(220, 53, 69);
                }
                
                doc.setFontSize(12);
                doc.text(title, 20, y);
                doc.setFontSize(10);
                doc.text(text, 30, y + 7);
                y += 15;
            });
            
            doc.setTextColor(0, 0, 0);
            
            // Recomendaciones
            if (!recommendationsSection.classList.contains('hidden')) {
                y += 10;
                doc.setFontSize(14);
                doc.text('Recomendaciones:', 20, y);
                y += 10;
                
                const lis = recommendationsList.querySelectorAll('li');
                lis.forEach(li => {
                    doc.setFontSize(10);
                    doc.text(`‚Ä¢ ${li.textContent}`, 20, y);
                    y += 7;
                });
            }
            
            // Predicci√≥n
            if (!predictionSection.classList.contains('hidden')) {
                y += 10;
                doc.setFontSize(14);
                doc.text('Predicci√≥n de Aprobaci√≥n:', 20, y);
                y += 10;
                
                doc.setFontSize(10);
                doc.text(predictionText.textContent, 20, y, { maxWidth: 170 });
            }
            
            // Guardar PDF
            doc.save(`Reporte_${studentName.textContent.replace(/ /g, '_')}.pdf`);
        }
        
        function exportGroupToPdf() {
            const { jsPDF } = window.jspdf;
            
            // Configuraci√≥n del PDF seg√∫n selecci√≥n del usuario
            const size = pageSize.value;
            const orientation = pageOrientation.value;
            
            let pageWidth, pageHeight;
            if (size === 'letter') {
                pageWidth = orientation === 'portrait' ? 216 : 279;
                pageHeight = orientation === 'portrait' ? 279 : 216;
            } else { // legal
                pageWidth = orientation === 'portrait' ? 216 : 356;
                pageHeight = orientation === 'portrait' ? 356 : 216;
            }
            
            const doc = new jsPDF({
                orientation: orientation,
                unit: 'mm',
                format: [pageWidth, pageHeight]
            });
            
            // T√≠tulo
            doc.setFontSize(18);
            doc.setTextColor(0, 123, 255);
            doc.text('Reporte Acad√©mico Grupal', pageWidth / 2, 20, { align: 'center' });
            
            // Filtros aplicados
            let filterText = 'Filtros aplicados: ';
            if (filterAll.checked) {
                filterText += 'Todos los estudiantes';
            } else if (filterRange.checked) {
                filterText += `Nota entre ${filterMin.value} y ${filterMax.value}`;
            } else if (filterGreater.checked) {
                filterText += `Nota mayor o igual a ${filterGreaterValue.value}`;
            } else if (filterLess.checked) {
                filterText += `Nota menor o igual a ${filterLessValue.value}`;
            }
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(filterText, 20, 30);
            
            // Estad√≠sticas
            const statsDiv = groupReportContent.querySelector('.group-report');
            const statsTitle = statsDiv.querySelector('.group-title').textContent;
            const statsItems = statsDiv.querySelectorAll('li');
            
            doc.setFontSize(14);
            doc.text(statsTitle, 20, 45);
            
            let y = 55;
            doc.setFontSize(10);
            statsItems.forEach(item => {
                doc.text(`‚Ä¢ ${item.textContent}`, 20, y);
                y += 7;
            });
            
            // Tabla de estudiantes
            y += 10;
            doc.setFontSize(14);
            doc.text('Listado de Estudiantes', 20, y);
            y += 10;
            
            const table = groupReportContent.querySelector('table');
            const rows = table.querySelectorAll('tr');
            
            // Configurar datos para autotable
            const headers = [];
            const data = [];
            
            // Encabezados
            const headerCells = rows[0].querySelectorAll('th');
            headerCells.forEach(cell => {
                headers.push(cell.textContent);
            });
            
            // Filas de datos
            for (let i = 1; i < rows.length; i++) {
                const rowData = [];
                const cells = rows[i].querySelectorAll('td');
                
                cells.forEach(cell => {
                    rowData.push(cell.textContent);
                });
                
                data.push(rowData);
            }
            
            // Configuraci√≥n de autotable
            doc.autoTable({
                startY: y,
                head: [headers],
                body: data,
                margin: { left: 20 },
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    overflow: 'linebreak'
                },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 'auto' },
                    2: { cellWidth: 'auto' },
                    3: { cellWidth: 20 },
                    4: { cellWidth: 20 }
                },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(`P√°gina ${data.pageNumber} de ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }
            });
            
            // Guardar PDF
            doc.save('Reporte_Grupal.pdf');
        }
    </script>
</body>
</html>