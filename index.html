<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes Académicos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --gray-color: #95a5a6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1, h2, h3 {
            color: var(--dark-color);
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 10px;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }

        input, select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        button.secondary {
            background-color: var(--gray-color);
        }

        button.secondary:hover {
            background-color: #7f8c8d;
        }

        button.success {
            background-color: var(--success-color);
        }

        button.success:hover {
            background-color: #27ae60;
        }

        button.danger {
            background-color: var(--danger-color);
        }

        button.danger:hover {
            background-color: #c0392b;
        }

        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-button {
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
        }

        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-name {
            margin-top: 5px;
            font-size: 14px;
            color: var(--gray-color);
        }

        .flex-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .flex-item {
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--primary-color);
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: #e9e9e9;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            padding: 10px 20px;
            background-color: #f1f1f1;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            background-color: white;
        }

        .tab-content.active {
            display: block;
        }

        .filter-container {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .filter-item {
            flex: 1;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .radio-option {
            display: flex;
            align-items: center;
        }

        .radio-option input {
            width: auto;
            margin-right: 5px;
        }

        .message-box {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .message-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .hidden {
            display: none;
        }

        .competence-table {
            margin-top: 20px;
        }

        .competence-table th {
            background-color: var(--dark-color);
        }

        .evaluation-table th {
            background-color: var(--secondary-color);
        }

        .pdf-settings {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .pdf-settings-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .pdf-settings-item {
            flex: 1;
        }

        .student-selector {
            margin-bottom: 15px;
        }

        /* Estilos para el spinner de carga */
        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 5px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mejorar feedback visual del botón */
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 5px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .checkbox-item input {
            width: auto;
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            .flex-container, .filter-row, .pdf-settings-row {
                flex-direction: column;
            }
            
            .flex-item, .filter-item, .pdf-settings-item {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sistema de Reportes Académicos</h1>
        
        <div class="section">
            <h2>Cargar Archivos</h2>
            
            <div class="flex-container">
                <div class="flex-item">
                    <div class="form-group">
                        <label for="notasFile">Archivo de Notas (Excel)</label>
                        <div class="file-input-container">
                            <div class="file-input-button">Seleccionar Archivo</div>
                            <input type="file" id="notasFile" class="file-input" accept=".xlsx, .xls">
                        </div>
                        <div id="notasFileName" class="file-name">No se ha seleccionado ningún archivo</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notasSheet">Hoja de trabajo</label>
                        <select id="notasSheet" disabled>
                            <option value="">Seleccione una hoja</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex-item">
                    <div class="form-group">
                        <label for="competenciasFile">Archivo de Competencias (Excel)</label>
                        <div class="file-input-container">
                            <div class="file-input-button">Seleccionar Archivo</div>
                            <input type="file" id="competenciasFile" class="file-input" accept=".xlsx, .xls">
                        </div>
                        <div id="competenciasFileName" class="file-name">No se ha seleccionado ningún archivo</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="competenciasSheet">Hoja de trabajo</label>
                        <select id="competenciasSheet" disabled>
                            <option value="">Seleccione una hoja</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <button id="loadDataBtn" class="secondary" disabled>Cargar Datos</button>
            </div>
        </div>
        
        <div id="configSection" class="section hidden">
            <h2>Configuración</h2>
            
            <div class="flex-container">
                <div class="flex-item">
                    <div class="form-group">
                        <label for="minGrade">Nota mínima de aprobación</label>
                        <input type="number" id="minGrade" min="0" max="10" step="0.01" value="3.00">
                    </div>
                </div>
                
                <div class="flex-item">
                    <div class="form-group">
                        <label for="maxGrade">Nota máxima</label>
                        <input type="number" id="maxGrade" min="0" max="10" step="0.01" value="5.00">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <button id="saveConfigBtn" class="success">Guardar Configuración</button>
            </div>
        </div>
        
        <div id="associationSection" class="section hidden">
            <h2>Asociación de Evaluaciones con Competencias</h2>
            
            <div id="associationMessage" class="message-box hidden"></div>
            
            <div class="form-group">
                <label>Seleccione las evaluaciones a procesar:</label>
                <div id="evaluationsCheckboxGroup" class="checkbox-group"></div>
            </div>
            
            <div class="form-group">
                <button id="loadAssociationsBtn" class="secondary">Cargar Asociaciones</button>
            </div>
            
            <div id="associationTableContainer" class="hidden">
                <table id="associationTable" class="competence-table">
                    <thead>
                        <tr>
                            <th>Evaluación</th>
                            <th>Competencia</th>
                            <th>Criterio</th>
                            <th>Porcentaje</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                
                <div class="form-group">
                    <button id="saveAssociationsBtn" class="success">Guardar Asociaciones</button>
                </div>
            </div>
        </div>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="individual">Reporte Individual</button>
                <button class="tab-button" data-tab="group">Reporte Grupal</button>
            </div>
            
            <div id="individual" class="tab-content active">
                <div class="section">
                    <h3>Reporte Individual</h3>
                    
                    <div class="student-selector">
                        <div class="form-group">
                            <label for="studentSelect">Seleccionar Estudiante</label>
                            <select id="studentSelect" disabled></select>
                        </div>
                        
                        <div class="form-group">
                            <label>Formato de visualización:</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="displayFull" name="displayFormat" value="full" checked>
                                    <label for="displayFull">ID y Apellidos/Nombres</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="displayId" name="displayFormat" value="id">
                                    <label for="displayId">Solo ID</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="displayName" name="displayFormat" value="name">
                                    <label for="displayName">Solo Apellidos/Nombres</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-container">
                        <h4>Filtros</h4>
                        <div class="filter-row">
                            <div class="filter-item">
                                <label for="filterMinGrade">Nota mínima</label>
                                <input type="number" id="filterMinGrade" min="0" max="10" step="0.01" placeholder="Mínimo">
                            </div>
                            <div class="filter-item">
                                <label for="filterMaxGrade">Nota máxima</label>
                                <input type="number" id="filterMaxGrade" min="0" max="10" step="0.01" placeholder="Máximo">
                            </div>
                        </div>
                        <div class="filter-row">
                            <div class="filter-item">
                                <button id="applyFilterBtn" class="secondary">Aplicar Filtros</button>
                            </div>
                            <div class="filter-item">
                                <button id="resetFilterBtn" class="secondary">Restablecer</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="individualResults" class="hidden">
                        <div id="studentInfo"></div>
                        
                        <div class="form-group">
                            <button id="predictGradesBtn" class="warning">Predecir Notas para Aprobar</button>
                        </div>
                        
                        <div id="predictionResult" class="message-box hidden"></div>
                        
                        <table id="individualTable" class="evaluation-table">
                            <thead>
                                <tr>
                                    <th>Evaluación</th>
                                    <th>Competencia</th>
                                    <th>Criterio</th>
                                    <th>Nota</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        
                        <div id="recommendations" class="message-box hidden"></div>
                        
                        <div class="pdf-settings">
                            <h4>Configuración de PDF</h4>
                            <div class="pdf-settings-row">
                                <div class="pdf-settings-item">
                                    <label for="pdfSize">Tamaño del papel</label>
                                    <select id="pdfSize">
                                        <option value="letter">Carta</option>
                                        <option value="legal">Oficio</option>
                                    </select>
                                </div>
                                <div class="pdf-settings-item">
                                    <label for="pdfOrientation">Orientación</label>
                                    <select id="pdfOrientation">
                                        <option value="portrait">Vertical</option>
                                        <option value="landscape">Horizontal</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <button id="exportIndividualPdfBtn" class="success">Exportar a PDF</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="group" class="tab-content">
                <div class="section">
                    <h3>Reporte Grupal</h3>
                    
                    <div class="form-group">
                        <label>Formato de visualización:</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="groupDisplayFull" name="groupDisplayFormat" value="full" checked>
                                <label for="groupDisplayFull">ID y Apellidos/Nombres</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="groupDisplayId" name="groupDisplayFormat" value="id">
                                <label for="groupDisplayId">Solo ID</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="groupDisplayName" name="groupDisplayFormat" value="name">
                                <label for="groupDisplayName">Solo Apellidos/Nombres</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-container">
                        <h4>Filtros</h4>
                        <div class="form-group">
                            <label for="groupFilterCondition">Condición de filtro:</label>
                            <select id="groupFilterCondition">
                                <option value="between">Nota entre dos valores</option>
                                <option value="less">Nota menor o igual a</option>
                                <option value="greater">Nota mayor o igual a</option>
                            </select>
                        </div>
                        <div class="filter-row" id="groupBetweenFilter">
                            <div class="filter-item">
                                <label for="groupFilterMinGrade">Nota mínima</label>
                                <input type="number" id="groupFilterMinGrade" min="0" max="10" step="0.01" placeholder="Mínimo">
                            </div>
                            <div class="filter-item">
                                <label for="groupFilterMaxGrade">Nota máxima</label>
                                <input type="number" id="groupFilterMaxGrade" min="0" max="10" step="0.01" placeholder="Máximo">
                            </div>
                        </div>
                        <div class="filter-row hidden" id="groupSingleFilter">
                            <div class="filter-item">
                                <label for="groupFilterValue">Valor</label>
                                <input type="number" id="groupFilterValue" min="0" max="10" step="0.01" placeholder="Valor">
                            </div>
                        </div>
                        <div class="filter-row">
                            <div class="filter-item">
                                <button id="applyGroupFilterBtn" class="secondary">Aplicar Filtros</button>
                            </div>
                            <div class="filter-item">
                                <button id="resetGroupFilterBtn" class="secondary">Restablecer</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="groupResults" class="hidden">
                        <div id="groupStats"></div>
                        
                        <div id="groupMotivation" class="message-box hidden"></div>
                        
                        <table id="groupTable" class="evaluation-table">
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th>Evaluación</th>
                                    <th>Competencia</th>
                                    <th>Criterio</th>
                                    <th>Nota</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        
                        <div class="pdf-settings">
                            <h4>Configuración de PDF</h4>
                            <div class="pdf-settings-row">
                                <div class="pdf-settings-item">
                                    <label for="groupPdfSize">Tamaño del papel</label>
                                    <select id="groupPdfSize">
                                        <option value="letter">Carta</option>
                                        <option value="legal">Oficio</option>
                                    </select>
                                </div>
                                <div class="pdf-settings-item">
                                    <label for="groupPdfOrientation">Orientación</label>
                                    <select id="groupPdfOrientation">
                                        <option value="portrait">Vertical</option>
                                        <option value="landscape">Horizontal</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <button id="exportGroupPdfBtn" class="success">Exportar a PDF</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let notasData = null;
        let competenciasData = null;
        let selectedEvaluations = [];
        let associations = [];
        let students = [];
        let currentStudent = null;
        let minGrade = 3.00;
        let maxGrade = 5.00;
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar eventos de los tabs
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // Actualizar botones activos
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Actualizar contenido activo
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Configurar eventos de los archivos
            document.getElementById('notasFile').addEventListener('change', function(e) {
                const fileName = e.target.files[0] ? e.target.files[0].name : 'No se ha seleccionado ningún archivo';
                document.getElementById('notasFileName').textContent = fileName;
                if (e.target.files[0]) {
                    loadExcelSheets(e.target.files[0], 'notasSheet');
                }
                checkLoadButton();
            });
            
            document.getElementById('competenciasFile').addEventListener('change', function(e) {
                const fileName = e.target.files[0] ? e.target.files[0].name : 'No se ha seleccionado ningún archivo';
                document.getElementById('competenciasFileName').textContent = fileName;
                if (e.target.files[0]) {
                    loadExcelSheets(e.target.files[0], 'competenciasSheet');
                }
                checkLoadButton();
            });
            
            // Configurar eventos de cambio para las hojas
            document.getElementById('notasSheet').addEventListener('change', checkLoadButton);
            document.getElementById('competenciasSheet').addEventListener('change', checkLoadButton);
            
            // Configurar evento del botón de carga
            document.getElementById('loadDataBtn').addEventListener('click', function() {
                // Agregar animación de carga
                this.innerHTML = '<span class="loading-spinner"></span> Cargando...';
                loadData();
            });
            
            // Configurar evento de guardar configuración
            document.getElementById('saveConfigBtn').addEventListener('click', saveConfig);
            
            // Configurar evento de cargar asociaciones
            document.getElementById('loadAssociationsBtn').addEventListener('click', loadAssociations);
            
            // Configurar evento de guardar asociaciones
            document.getElementById('saveAssociationsBtn').addEventListener('click', saveAssociations);
            
            // Configurar eventos del reporte individual
            document.getElementById('studentSelect').addEventListener('change', updateIndividualReport);
            
            // Configurar eventos de filtros individuales
            document.getElementById('applyFilterBtn').addEventListener('click', applyIndividualFilters);
            document.getElementById('resetFilterBtn').addEventListener('click', resetIndividualFilters);
            
            // Configurar evento de predicción de notas
            document.getElementById('predictGradesBtn').addEventListener('click', predictGrades);
            
            // Configurar evento de exportación PDF individual
            document.getElementById('exportIndividualPdfBtn').addEventListener('click', exportIndividualPdf);
            
            // Configurar eventos del reporte grupal
            document.getElementById('groupFilterCondition').addEventListener('change', updateGroupFilterUI);
            
            // Configurar eventos de filtros grupales
            document.getElementById('applyGroupFilterBtn').addEventListener('click', applyGroupFilters);
            document.getElementById('resetGroupFilterBtn').addEventListener('click', resetGroupFilters);
            
            // Configurar evento de exportación PDF grupal
            document.getElementById('exportGroupPdfBtn').addEventListener('click', exportGroupPdf);
            
            // Inicializar controles de visualización
            updateDisplayFormat();
            document.querySelectorAll('input[name="displayFormat"]').forEach(radio => {
                radio.addEventListener('change', updateDisplayFormat);
            });
            
            document.querySelectorAll('input[name="groupDisplayFormat"]').forEach(radio => {
                radio.addEventListener('change', updateGroupDisplayFormat);
            });
        });
        
        // Función para verificar si se puede habilitar el botón de carga
        function checkLoadButton() {
            const notasFile = document.getElementById('notasFile').files[0];
            const competenciasFile = document.getElementById('competenciasFile').files[0];
            const notasSheet = document.getElementById('notasSheet').value;
            const competenciasSheet = document.getElementById('competenciasSheet').value;
            
            // Verificar que existan archivos y hojas seleccionadas
            const canLoad = notasFile && competenciasFile && notasSheet && competenciasSheet;
            
            // Habilitar/deshabilitar botón
            const loadBtn = document.getElementById('loadDataBtn');
            loadBtn.disabled = !canLoad;
            
            // Cambiar clase para feedback visual
            if (canLoad) {
                loadBtn.classList.remove('secondary');
                loadBtn.classList.add('success');
            } else {
                loadBtn.classList.remove('success');
                loadBtn.classList.add('secondary');
            }
        }
        
        // Función para cargar las hojas de un archivo Excel
        function loadExcelSheets(file, selectId) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const sheetSelect = document.getElementById(selectId);
                    sheetSelect.innerHTML = '<option value="">Seleccione una hoja</option>';
                    
                    workbook.SheetNames.forEach(sheetName => {
                        const option = document.createElement('option');
                        option.value = sheetName;
                        option.textContent = sheetName;
                        sheetSelect.appendChild(option);
                    });
                    
                    sheetSelect.disabled = false;
                    checkLoadButton();
                    
                } catch (error) {
                    console.error('Error al leer el archivo Excel:', error);
                    showMessage('Error al leer el archivo Excel: ' + error.message, 'danger');
                }
            };
            
            reader.onerror = function(error) {
                console.error('Error al leer el archivo:', error);
                showMessage('Error al leer el archivo: ' + error.message, 'danger');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Función para cargar los datos de los archivos Excel
        function loadData() {
            // Mostrar mensaje de carga
            showMessage('Cargando datos, por favor espere...', 'warning');
            
            const notasFile = document.getElementById('notasFile').files[0];
            const competenciasFile = document.getElementById('competenciasFile').files[0];
            const notasSheet = document.getElementById('notasSheet').value;
            const competenciasSheet = document.getElementById('competenciasSheet').value;
            
            if (!notasFile || !competenciasFile || !notasSheet || !competenciasSheet) {
                showMessage('Por favor seleccione ambos archivos y sus hojas correspondientes', 'danger');
                return;
            }
            
            // Función para manejar errores
            const handleError = (error) => {
                console.error('Error al cargar datos:', error);
                showMessage('Error al cargar los datos: ' + error.message, 'danger');
                document.getElementById('loadDataBtn').disabled = false;
                document.getElementById('loadDataBtn').textContent = 'Cargar Datos';
            };
            
            // Cargar archivo de notas
            const notasReader = new FileReader();
            
            notasReader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Verificar que la hoja exista
                    if (!workbook.SheetNames.includes(notasSheet)) {
                        throw new Error(`La hoja "${notasSheet}" no existe en el archivo de notas`);
                    }
                    
                    // Convertir a JSON con encabezados
                    const worksheet = workbook.Sheets[notasSheet];
                    notasData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Cargar archivo de competencias
                    const competenciasReader = new FileReader();
                    
                    competenciasReader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            // Verificar que la hoja exista
                            if (!workbook.SheetNames.includes(competenciasSheet)) {
                                throw new Error(`La hoja "${competenciasSheet}" no existe en el archivo de competencias`);
                            }
                            
                            // Convertir a JSON con encabezados
                            const worksheet = workbook.Sheets[competenciasSheet];
                            competenciasData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            // Procesar datos
                            processData();
                            
                            // Restaurar botón
                            document.getElementById('loadDataBtn').disabled = false;
                            document.getElementById('loadDataBtn').innerHTML = 'Cargar Datos';
                            
                        } catch (error) {
                            handleError(error);
                        }
                    };
                    
                    competenciasReader.onerror = handleError;
                    competenciasReader.readAsArrayBuffer(competenciasFile);
                    
                } catch (error) {
                    handleError(error);
                }
            };
            
            notasReader.onerror = handleError;
            notasReader.readAsArrayBuffer(notasFile);
        }
        
        // Función para procesar los datos cargados
        function processData() {
            if (!notasData || notasData.length < 2 || !competenciasData || competenciasData.length < 2) {
                showMessage('Los archivos no contienen datos válidos', 'danger');
                return;
            }
            
            // Procesar encabezados de notas
            const notasHeaders = notasData[0].map(h => h ? h.toString().trim() : '');
            const notasRows = notasData.slice(1);
            
            // Identificar columnas clave
            const idIndex = notasHeaders.findIndex(h => h.toLowerCase().includes('id'));
            const nameIndex = notasHeaders.findIndex(h => 
                h.toLowerCase().includes('nombre') || 
                h.toLowerCase().includes('apellido') ||
                h.toLowerCase().includes('nombres') ||
                h.toLowerCase().includes('apellidos')
            );
            
            // Identificar columnas de evaluaciones (todas las que no son ID ni nombre)
            const evaluationIndices = [];
            notasHeaders.forEach((header, index) => {
                if (index !== idIndex && index !== nameIndex && header && header.trim() !== '') {
                    evaluationIndices.push(index);
                }
            });
            
            if (idIndex === -1 || nameIndex === -1 || evaluationIndices.length === 0) {
                showMessage('El archivo de notas no tiene el formato correcto. Debe contener columnas para ID, Nombres y evaluaciones.', 'danger');
                return;
            }
            
            // Procesar estudiantes
            students = [];
            notasRows.forEach(row => {
                if (row.length === 0) return; // Saltar filas vacías
                
                const student = {
                    id: row[idIndex] ? row[idIndex].toString().trim() : 'Sin ID',
                    name: row[nameIndex] ? row[nameIndex].toString().trim() : 'Sin nombre',
                    evaluations: {}
                };
                
                evaluationIndices.forEach(index => {
                    const evalName = notasHeaders[index];
                    let grade = 0;
                    
                    // Manejar diferentes formatos de nota
                    if (row[index] !== undefined && row[index] !== null && row[index] !== '') {
                        if (typeof row[index] === 'number') {
                            grade = row[index];
                        } else if (typeof row[index] === 'string') {
                            grade = parseFloat(row[index].replace(',', '.')) || 0;
                        }
                    }
                    
                    student.evaluations[evalName] = grade;
                });
                
                students.push(student);
            });
            
            // Procesar competencias
            const compHeaders = competenciasData[0].map(h => h ? h.toString().trim() : '');
            const compRows = competenciasData.slice(1);
            
            const compIndex = compHeaders.findIndex(h => h.toLowerCase().includes('competencia'));
            const critIndex = compHeaders.findIndex(h => h.toLowerCase().includes('criterio'));
            
            if (compIndex === -1 || critIndex === -1) {
                showMessage('El archivo de competencias no tiene el formato correcto. Debe contener columnas para Competencia y Criterio.', 'danger');
                return;
            }
            
            // Mostrar secciones de configuración y asociación
            document.getElementById('configSection').classList.remove('hidden');
            document.getElementById('associationSection').classList.remove('hidden');
            
            // Llenar selección de evaluaciones
            const evalCheckboxGroup = document.getElementById('evaluationsCheckboxGroup');
            evalCheckboxGroup.innerHTML = '';
            
            evaluationIndices.forEach(index => {
                const evalName = notasHeaders[index];
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `eval-${index}`;
                checkbox.value = evalName;
                checkbox.checked = true; // Seleccionar por defecto
                
                const label = document.createElement('label');
                label.htmlFor = `eval-${index}`;
                label.textContent = evalName;
                label.style.marginLeft = '5px';
                
                div.appendChild(checkbox);
                div.appendChild(label);
                evalCheckboxGroup.appendChild(div);
            });
            
            // Llenar selección de estudiantes
            const studentSelect = document.getElementById('studentSelect');
            studentSelect.innerHTML = '';
            studentSelect.disabled = false;
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.id} - ${student.name}`;
                studentSelect.appendChild(option);
            });
            
            showMessage('Datos cargados correctamente', 'success');
        }
        
        // Función para guardar la configuración
        function saveConfig() {
            minGrade = parseFloat(document.getElementById('minGrade').value) || 3.00;
            maxGrade = parseFloat(document.getElementById('maxGrade').value) || 5.00;
            
            showMessage('Configuración guardada correctamente', 'success');
        }
        
        // Función para cargar las asociaciones
        function loadAssociations() {
            const checkboxes = document.querySelectorAll('#evaluationsCheckboxGroup input[type="checkbox"]:checked');
            selectedEvaluations = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedEvaluations.length === 0) {
                showMessage('Por favor seleccione al menos una evaluación', 'danger');
                return;
            }
            
            // Procesar competencias para el selector
            const compHeaders = competenciasData[0].map(h => h ? h.toString().trim() : '');
            const compRows = competenciasData.slice(1);
            
            const compIndex = compHeaders.findIndex(h => h.toLowerCase().includes('competencia'));
            const critIndex = compHeaders.findIndex(h => h.toLowerCase().includes('criterio'));
            
            // Obtener competencias únicas
            const competencias = [...new Set(compRows.map(row => {
                return row[compIndex] ? row[compIndex].toString().trim() : 'Sin competencia';
            }))].filter(c => c !== '');
            
            // Mostrar tabla de asociaciones
            const tableBody = document.querySelector('#associationTable tbody');
            tableBody.innerHTML = '';
            
            selectedEvaluations.forEach(evalName => {
                const row = document.createElement('tr');
                
                // Columna Evaluación
                const evalCell = document.createElement('td');
                evalCell.textContent = evalName;
                row.appendChild(evalCell);
                
                // Columna Competencia (select)
                const compCell = document.createElement('td');
                const compSelect = document.createElement('select');
                compSelect.className = 'competence-select';
                compSelect.style.width = '100%';
                
                // Opción vacía inicial
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'Seleccione competencia';
                compSelect.appendChild(emptyOption);
                
                // Agregar competencias
                competencias.forEach(comp => {
                    const option = document.createElement('option');
                    option.value = comp;
                    option.textContent = comp;
                    compSelect.appendChild(option);
                });
                
                compCell.appendChild(compSelect);
                row.appendChild(compCell);
                
                // Columna Criterio (select)
                const critCell = document.createElement('td');
                const critSelect = document.createElement('select');
                critSelect.className = 'criterion-select';
                critSelect.style.width = '100%';
                critSelect.disabled = true;
                
                // Opción vacía inicial
                const emptyCritOption = document.createElement('option');
                emptyCritOption.value = '';
                emptyCritOption.textContent = 'Seleccione criterio';
                critSelect.appendChild(emptyCritOption);
                
                // Actualizar criterios cuando cambia la competencia
                compSelect.addEventListener('change', function() {
                    updateCriteriaSelect(this, critSelect);
                });
                
                critCell.appendChild(critSelect);
                row.appendChild(critCell);
                
                // Columna Porcentaje
                const percCell = document.createElement('td');
                const percInput = document.createElement('input');
                percInput.type = 'number';
                percInput.min = '0';
                percInput.max = '100';
                percInput.step = '0.01';
                percInput.value = (100 / selectedEvaluations.length).toFixed(2);
                percInput.style.width = '100%';
                percInput.style.boxSizing = 'border-box';
                percCell.appendChild(percInput);
                row.appendChild(percCell);
                
                tableBody.appendChild(row);
            });
            
            document.getElementById('associationTableContainer').classList.remove('hidden');
        }
        
        // Función para actualizar los criterios cuando cambia la competencia
        function updateCriteriaSelect(compSelect, critSelect) {
            const selectedComp = compSelect.value;
            
            if (!selectedComp) {
                critSelect.innerHTML = '<option value="">Seleccione criterio</option>';
                critSelect.disabled = true;
                return;
            }
            
            const compHeaders = competenciasData[0].map(h => h ? h.toString().trim() : '');
            const compRows = competenciasData.slice(1);
            
            const compIndex = compHeaders.findIndex(h => h.toLowerCase().includes('competencia'));
            const critIndex = compHeaders.findIndex(h => h.toLowerCase().includes('criterio'));
            
            critSelect.innerHTML = '';
            critSelect.disabled = false;
            
            // Opción vacía inicial
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'Seleccione criterio';
            critSelect.appendChild(emptyOption);
            
            // Filtrar criterios para la competencia seleccionada
            const criterios = [];
            
            compRows.forEach(row => {
                if (row[compIndex] && row[compIndex].toString().trim() === selectedComp) {
                    const criterio = row[critIndex] ? row[critIndex].toString().trim() : 'Sin criterio';
                    if (criterio && !criterios.includes(criterio)) {
                        criterios.push(criterio);
                    }
                }
            });
            
            // Agregar criterios al select
            criterios.forEach(crit => {
                const option = document.createElement('option');
                option.value = crit;
                option.textContent = crit;
                critSelect.appendChild(option);
            });
        }
        
        // Función para guardar las asociaciones
        function saveAssociations() {
            associations = [];
            const rows = document.querySelectorAll('#associationTable tbody tr');
            
            let totalPercentage = 0;
            let hasErrors = false;
            
            rows.forEach(row => {
                const evalName = row.cells[0].textContent;
                const competence = row.cells[1].querySelector('select').value;
                const criterion = row.cells[2].querySelector('select').value;
                const percentage = parseFloat(row.cells[3].querySelector('input').value) || 0;
                
                // Validar campos obligatorios
                if (!competence || !criterion) {
                    hasErrors = true;
                    showMessage('Por favor seleccione competencia y criterio para todas las evaluaciones', 'danger');
                    return;
                }
                
                associations.push({
                    evaluation: evalName,
                    competence: competence,
                    criterion: criterion,
                    percentage: percentage
                });
                
                totalPercentage += percentage;
            });
            
            if (hasErrors) return;
            
            if (Math.abs(totalPercentage - 100) > 0.01) {
                showMessage(`La suma de porcentajes es ${totalPercentage.toFixed(2)}%. Debe ser exactamente 100%.`, 'danger');
                return;
            }
            
            showMessage('Asociaciones guardadas correctamente', 'success');
            
            // Actualizar reportes
            updateIndividualReport();
            updateGroupReport();
        }
        
        // Función para actualizar el reporte individual
        function updateIndividualReport() {
            const studentId = document.getElementById('studentSelect').value;
            currentStudent = students.find(s => s.id === studentId);
            
            if (!currentStudent || associations.length === 0) {
                document.getElementById('individualResults').classList.add('hidden');
                return;
            }
            
            document.getElementById('individualResults').classList.remove('hidden');
            
            // Mostrar información del estudiante
            const displayFormat = document.querySelector('input[name="displayFormat"]:checked').value;
            let studentDisplay = '';
            
            switch (displayFormat) {
                case 'id':
                    studentDisplay = currentStudent.id;
                    break;
                case 'name':
                    studentDisplay = currentStudent.name;
                    break;
                default:
                    studentDisplay = `${currentStudent.id} - ${currentStudent.name}`;
            }
            
            document.getElementById('studentInfo').innerHTML = `<h3>${studentDisplay}</h3>`;
            
            // Generar tabla de resultados
            const tableBody = document.querySelector('#individualTable tbody');
            tableBody.innerHTML = '';
            
            let approvedCount = 0;
            let totalCount = 0;
            
            associations.forEach(assoc => {
                const evaluation = currentStudent.evaluations[assoc.evaluation] || 0;
                const isApproved = evaluation >= minGrade;
                
                if (isApproved) approvedCount++;
                totalCount++;
                
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${assoc.evaluation}</td>
                    <td>${assoc.competence}</td>
                    <td>${assoc.criterion}</td>
                    <td>${evaluation.toFixed(2)}</td>
                    <td><span class="badge ${isApproved ? 'badge-success' : 'badge-danger'}">${isApproved ? 'Aprobado' : 'No aprobado'}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Mostrar recomendaciones
            const recommendationsDiv = document.getElementById('recommendations');
            recommendationsDiv.classList.remove('hidden');
            
            if (approvedCount === totalCount) {
                recommendationsDiv.className = 'message-box message-success';
                recommendationsDiv.innerHTML = '<p>¡Felicidades! El estudiante ha aprobado todas las competencias evaluadas.</p>';
            } else {
                const percentage = (approvedCount / totalCount * 100).toFixed(2);
                recommendationsDiv.className = 'message-box message-danger';
                recommendationsDiv.innerHTML = `
                    <p>El estudiante ha aprobado ${approvedCount} de ${totalCount} competencias (${percentage}%).</p>
                    <p><strong>Recomendaciones:</strong></p>
                    <ul>
                        <li>Se recomienda asistir a clase de forma continua y participar activamente.</li>
                        <li>Realizar las tareas y ejercicios sugeridos por el docente.</li>
                        <li>Asistir a las asesorías programadas para reforzar los temas con dificultad.</li>
                        <li>Revisar el material de estudio y practicar regularmente.</li>
                    </ul>
                `;
            }
            
            // Limpiar predicción anterior
            document.getElementById('predictionResult').classList.add('hidden');
        }
        
        // Función para aplicar filtros individuales
        function applyIndividualFilters() {
            const min = parseFloat(document.getElementById('filterMinGrade').value);
            const max = parseFloat(document.getElementById('filterMaxGrade').value);
            
            const rows = document.querySelectorAll('#individualTable tbody tr');
            
            rows.forEach(row => {
                const grade = parseFloat(row.cells[3].textContent);
                let showRow = true;
                
                if (!isNaN(min) && grade < min) {
                    showRow = false;
                }
                
                if (!isNaN(max) && grade > max) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }
        
        // Función para restablecer filtros individuales
        function resetIndividualFilters() {
            document.getElementById('filterMinGrade').value = '';
            document.getElementById('filterMaxGrade').value = '';
            
            const rows = document.querySelectorAll('#individualTable tbody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Función para predecir notas faltantes
        function predictGrades() {
            if (!currentStudent || associations.length === 0) return;
            
            // Calcular promedio actual ponderado
            let totalWeighted = 0;
            let totalPercentage = 0;
            let missingEvaluations = [];
            
            associations.forEach(assoc => {
                const grade = currentStudent.evaluations[assoc.evaluation] || 0;
                
                if (grade === 0) {
                    missingEvaluations.push({
                        name: assoc.evaluation,
                        percentage: assoc.percentage
                    });
                } else {
                    totalWeighted += grade * assoc.percentage / 100;
                    totalPercentage += assoc.percentage;
                }
            });
            
            if (missingEvaluations.length === 0) {
                const currentAverage = totalWeighted / (totalPercentage / 100);
                const resultDiv = document.getElementById('predictionResult');
                resultDiv.className = 'message-box message-success';
                resultDiv.innerHTML = `<p>El estudiante ya tiene todas las evaluaciones completas. Promedio actual: ${currentAverage.toFixed(2)}</p>`;
                resultDiv.classList.remove('hidden');
                return;
            }
            
            // Calcular nota necesaria para alcanzar el mínimo
            const remainingPercentage = 100 - totalPercentage;
            const neededWeighted = minGrade - totalWeighted;
            const neededGrade = (neededWeighted * 100) / remainingPercentage;
            
            const resultDiv = document.getElementById('predictionResult');
            resultDiv.className = 'message-box message-warning';
            
            if (neededGrade > maxGrade) {
                resultDiv.innerHTML = `
                    <p>Para alcanzar la nota mínima de ${minGrade.toFixed(2)}, el estudiante necesita un promedio de ${neededGrade.toFixed(2)} en las siguientes evaluaciones:</p>
                    <ul>
                        ${missingEvaluations.map(e => `<li>${e.name} (${e.percentage}%)</li>`).join('')}
                    </ul>
                    <p>Sin embargo, esto excede la nota máxima permitida de ${maxGrade.toFixed(2)}. Se recomienda reforzamiento adicional.</p>
                `;
            } else if (neededGrade < 0) {
                resultDiv.innerHTML = `
                    <p>El estudiante ya ha superado la nota mínima de aprobación con las evaluaciones existentes.</p>
                    <p>Promedio actual proyectado: ${(totalWeighted / (totalPercentage / 100)).toFixed(2)}</p>
                `;
            } else {
                resultDiv.innerHTML = `
                    <p>Para alcanzar la nota mínima de ${minGrade.toFixed(2)}, el estudiante necesita un promedio de ${neededGrade.toFixed(2)} en las siguientes evaluaciones:</p>
                    <ul>
                        ${missingEvaluations.map(e => `<li>${e.name} (${e.percentage}%)</li>`).join('')}
                    </ul>
                    <p>Promedio actual con evaluaciones existentes: ${(totalWeighted / (totalPercentage / 100)).toFixed(2)}</p>
                `;
            }
            
            resultDiv.classList.remove('hidden');
        }
        
        // Función para actualizar el reporte grupal
        function updateGroupReport() {
            if (students.length === 0 || associations.length === 0) {
                document.getElementById('groupResults').classList.add('hidden');
                return;
            }
            
            document.getElementById('groupResults').classList.remove('hidden');
            
            // Generar tabla de resultados
            const tableBody = document.querySelector('#groupTable tbody');
            tableBody.innerHTML = '';
            
            let totalStudents = students.length;
            let approvedStudents = 0;
            let totalEvaluations = 0;
            let approvedEvaluations = 0;
            
            students.forEach(student => {
                let studentApproved = true;
                
                associations.forEach(assoc => {
                    const evaluation = student.evaluations[assoc.evaluation] || 0;
                    const isApproved = evaluation >= minGrade;
                    
                    if (!isApproved) studentApproved = false;
                    
                    totalEvaluations++;
                    if (isApproved) approvedEvaluations++;
                    
                    const displayFormat = document.querySelector('input[name="groupDisplayFormat"]:checked').value;
                    let studentDisplay = '';
                    
                    switch (displayFormat) {
                        case 'id':
                            studentDisplay = student.id;
                            break;
                        case 'name':
                            studentDisplay = student.name;
                            break;
                        default:
                            studentDisplay = `${student.id} - ${student.name}`;
                    }
                    
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${studentDisplay}</td>
                        <td>${assoc.evaluation}</td>
                        <td>${assoc.competence}</td>
                        <td>${assoc.criterion}</td>
                        <td>${evaluation.toFixed(2)}</td>
                        <td><span class="badge ${isApproved ? 'badge-success' : 'badge-danger'}">${isApproved ? 'Aprobado' : 'No aprobado'}</span></td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                if (studentApproved) approvedStudents++;
            });
            
            // Mostrar estadísticas
            const statsDiv = document.getElementById('groupStats');
            const approvalRate = (approvedStudents / totalStudents * 100).toFixed(2);
            const evalApprovalRate = (approvedEvaluations / totalEvaluations * 100).toFixed(2);
            
            statsDiv.innerHTML = `
                <h4>Estadísticas del Grupo</h4>
                <p>Total estudiantes: ${totalStudents}</p>
                <p>Estudiantes que aprobaron todas las competencias: ${approvedStudents} (${approvalRate}%)</p>
                <p>Evaluaciones aprobadas: ${approvedEvaluations} de ${totalEvaluations} (${evalApprovalRate}%)</p>
            `;
            
            // Mostrar mensaje motivacional
            const motivationDiv = document.getElementById('groupMotivation');
            motivationDiv.classList.remove('hidden');
            
            if (approvalRate >= 80) {
                motivationDiv.className = 'message-box message-success';
                motivationDiv.innerHTML = `
                    <p>¡Excelente trabajo! La mayoría del grupo ha aprobado las competencias.</p>
                    <p>Continúen con el buen rendimiento y mantengan el ritmo de aprendizaje.</p>
                `;
            } else if (approvalRate >= 50) {
                motivationDiv.className = 'message-box message-warning';
                motivationDiv.innerHTML = `
                    <p>El grupo está mostrando un rendimiento aceptable, pero hay margen de mejora.</p>
                    <p>Se recomienda reforzar los temas con mayor dificultad y fomentar el estudio grupal.</p>
                `;
            } else {
                motivationDiv.className = 'message-box message-danger';
                motivationDiv.innerHTML = `
                    <p>El grupo necesita mejorar su rendimiento académico.</p>
                    <p><strong>Recomendaciones:</strong></p>
                    <ul>
                        <li>Organizar sesiones de refuerzo para los temas con mayor dificultad.</li>
                        <li>Fomentar el estudio colaborativo y los grupos de trabajo.</li>
                        <li>Revisar las estrategias de enseñanza para adaptarlas a las necesidades del grupo.</li>
                        <li>Proporcionar retroalimentación detallada sobre los aspectos a mejorar.</li>
                    </ul>
                `;
            }
        }
        
        // Función para actualizar la UI de filtros grupales
        function updateGroupFilterUI() {
            const condition = document.getElementById('groupFilterCondition').value;
            
            document.getElementById('groupBetweenFilter').classList.add('hidden');
            document.getElementById('groupSingleFilter').classList.add('hidden');
            
            if (condition === 'between') {
                document.getElementById('groupBetweenFilter').classList.remove('hidden');
            } else {
                document.getElementById('groupSingleFilter').classList.remove('hidden');
            }
        }
        
        // Función para aplicar filtros grupales
        function applyGroupFilters() {
            const condition = document.getElementById('groupFilterCondition').value;
            const min = parseFloat(document.getElementById('groupFilterMinGrade').value);
            const max = parseFloat(document.getElementById('groupFilterMaxGrade').value);
            const value = parseFloat(document.getElementById('groupFilterValue').value);
            
            const rows = document.querySelectorAll('#groupTable tbody tr');
            
            rows.forEach(row => {
                const grade = parseFloat(row.cells[4].textContent);
                let showRow = true;
                
                switch (condition) {
                    case 'between':
                        if ((!isNaN(min) && grade < min) || (!isNaN(max) && grade > max)) {
                            showRow = false;
                        }
                        break;
                    case 'less':
                        if (!isNaN(value) && grade > value) {
                            showRow = false;
                        }
                        break;
                    case 'greater':
                        if (!isNaN(value) && grade < value) {
                            showRow = false;
                        }
                        break;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }
        
        // Función para restablecer filtros grupales
        function resetGroupFilters() {
            document.getElementById('groupFilterMinGrade').value = '';
            document.getElementById('groupFilterMaxGrade').value = '';
            document.getElementById('groupFilterValue').value = '';
            
            const rows = document.querySelectorAll('#groupTable tbody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Función para actualizar el formato de visualización
        function updateDisplayFormat() {
            if (!currentStudent) return;
            
            const displayFormat = document.querySelector('input[name="displayFormat"]:checked').value;
            let studentDisplay = '';
            
            switch (displayFormat) {
                case 'id':
                    studentDisplay = currentStudent.id;
                    break;
                case 'name':
                    studentDisplay = currentStudent.name;
                    break;
                default:
                    studentDisplay = `${currentStudent.id} - ${currentStudent.name}`;
            }
            
            document.getElementById('studentInfo').innerHTML = `<h3>${studentDisplay}</h3>`;
        }
        
        // Función para actualizar el formato de visualización grupal
        function updateGroupDisplayFormat() {
            if (students.length === 0) return;
            
            const rows = document.querySelectorAll('#groupTable tbody tr');
            const displayFormat = document.querySelector('input[name="groupDisplayFormat"]:checked').value;
            
            students.forEach((student, i) => {
                let studentDisplay = '';
                
                switch (displayFormat) {
                    case 'id':
                        studentDisplay = student.id;
                        break;
                    case 'name':
                        studentDisplay = student.name;
                        break;
                    default:
                        studentDisplay = `${student.id} - ${student.name}`;
                }
                
                // Cada estudiante tiene asociaciones.length filas
                for (let j = 0; j < associations.length; j++) {
                    const rowIndex = i * associations.length + j;
                    if (rowIndex < rows.length) {
                        rows[rowIndex].cells[0].textContent = studentDisplay;
                    }
                }
            });
        }
        
        // Función para exportar reporte individual a PDF
        function exportIndividualPdf() {
            if (!currentStudent) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: document.getElementById('pdfOrientation').value,
                unit: 'mm',
                format: document.getElementById('pdfSize').value
            });
            
            // Configuración del PDF
            const margin = 10;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const maxWidth = pageWidth - 2 * margin;
            
            // Título
            const displayFormat = document.querySelector('input[name="displayFormat"]:checked').value;
            let studentDisplay = '';
            
            switch (displayFormat) {
                case 'id':
                    studentDisplay = currentStudent.id;
                    break;
                case 'name':
                    studentDisplay = currentStudent.name;
                    break;
                default:
                    studentDisplay = `${currentStudent.id} - ${currentStudent.name}`;
            }
            
            doc.setFontSize(16);
            doc.text(`Reporte Individual - ${studentDisplay}`, margin, margin + 10);
            
            // Información del estudiante
            doc.setFontSize(12);
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, margin, margin + 20);
            doc.text(`Nota mínima de aprobación: ${minGrade.toFixed(2)}`, margin, margin + 25);
            doc.text(`Nota máxima: ${maxGrade.toFixed(2)}`, margin, margin + 30);
            
            // Tabla de resultados
            const headers = [
                { title: "Evaluación", dataKey: "evaluation" },
                { title: "Competencia", dataKey: "competence" },
                { title: "Criterio", dataKey: "criterion" },
                { title: "Nota", dataKey: "grade" },
                { title: "Estado", dataKey: "status" }
            ];
            
            const data = associations.map(assoc => {
                const evaluation = currentStudent.evaluations[assoc.evaluation] || 0;
                const isApproved = evaluation >= minGrade;
                
                return {
                    evaluation: assoc.evaluation,
                    competence: assoc.competence,
                    criterion: assoc.criterion,
                    grade: evaluation.toFixed(2),
                    status: isApproved ? 'Aprobado' : 'No aprobado'
                };
            });
            
            doc.autoTable({
                startY: margin + 35,
                head: [headers.map(h => h.title)],
                body: data.map(row => headers.map(h => row[h.dataKey])),
                margin: { left: margin, right: margin },
                styles: {
                    fontSize: 10,
                    cellPadding: 3,
                    overflow: 'linebreak'
                },
                headStyles: {
                    fillColor: [52, 152, 219],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [242, 242, 242]
                },
                columnStyles: {
                    3: { cellWidth: 20 },
                    4: { cellWidth: 20 }
                }
            });
            
            // Estadísticas
            let lastY = doc.lastAutoTable.finalY + 10;
            
            if (lastY > pageHeight - 30) {
                doc.addPage();
                lastY = margin;
            }
            
            doc.setFontSize(12);
            doc.text('Estadísticas:', margin, lastY);
            
            let approvedCount = 0;
            associations.forEach(assoc => {
                const evaluation = currentStudent.evaluations[assoc.evaluation] || 0;
                if (evaluation >= minGrade) approvedCount++;
            });
            
            const percentage = (approvedCount / associations.length * 100).toFixed(2);
            
            doc.setFontSize(10);
            doc.text(`Competencias aprobadas: ${approvedCount} de ${associations.length} (${percentage}%)`, margin + 5, lastY + 10);
            
            // Recomendaciones
            lastY += 20;
            
            if (lastY > pageHeight - 50) {
                doc.addPage();
                lastY = margin;
            }
            
            doc.setFontSize(12);
            doc.text('Recomendaciones:', margin, lastY);
            
            doc.setFontSize(10);
            if (approvedCount === associations.length) {
                doc.text('¡Felicidades! El estudiante ha aprobado todas las competencias evaluadas.', margin + 5, lastY + 10);
            } else {
                const recommendations = [
                    'Se recomienda asistir a clase de forma continua y participar activamente.',
                    'Realizar las tareas y ejercicios sugeridos por el docente.',
                    'Asistir a las asesorías programadas para reforzar los temas con dificultad.',
                    'Revisar el material de estudio y practicar regularmente.'
                ];
                
                recommendations.forEach((rec, i) => {
                    if (lastY + 15 + (i * 5) > pageHeight - 10) {
                        doc.addPage();
                        lastY = margin;
                    }
                    doc.text(`• ${rec}`, margin + 5, lastY + 10 + (i * 5));
                });
            }
            
            // Guardar PDF
            doc.save(`Reporte_Individual_${studentDisplay.replace(/ /g, '_')}.pdf`);
        }
        
        // Función para exportar reporte grupal a PDF
        function exportGroupPdf() {
            if (students.length === 0 || associations.length === 0) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: document.getElementById('groupPdfOrientation').value,
                unit: 'mm',
                format: document.getElementById('groupPdfSize').value
            });
            
            // Configuración del PDF
            const margin = 10;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const maxWidth = pageWidth - 2 * margin;
            
            // Título
            doc.setFontSize(16);
            doc.text('Reporte Grupal', margin, margin + 10);
            
            // Información general
            doc.setFontSize(12);
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, margin, margin + 20);
            doc.text(`Nota mínima de aprobación: ${minGrade.toFixed(2)}`, margin, margin + 25);
            doc.text(`Nota máxima: ${maxGrade.toFixed(2)}`, margin, margin + 30);
            
            // Calcular estadísticas
            let totalStudents = students.length;
            let approvedStudents = 0;
            let totalEvaluations = students.length * associations.length;
            let approvedEvaluations = 0;
            
            students.forEach(student => {
                let studentApproved = true;
                
                associations.forEach(assoc => {
                    const evaluation = student.evaluations[assoc.evaluation] || 0;
                    if (evaluation >= minGrade) {
                        approvedEvaluations++;
                    } else {
                        studentApproved = false;
                    }
                });
                
                if (studentApproved) approvedStudents++;
            });
            
            const approvalRate = (approvedStudents / totalStudents * 100).toFixed(2);
            const evalApprovalRate = (approvedEvaluations / totalEvaluations * 100).toFixed(2);
            
            doc.text(`Total estudiantes: ${totalStudents}`, margin, margin + 35);
            doc.text(`Estudiantes que aprobaron todas las competencias: ${approvedStudents} (${approvalRate}%)`, margin, margin + 40);
            doc.text(`Evaluaciones aprobadas: ${approvedEvaluations} de ${totalEvaluations} (${evalApprovalRate}%)`, margin, margin + 45);
            
            // Tabla de resultados
            const headers = [
                { title: "Estudiante", dataKey: "student" },
                { title: "Evaluación", dataKey: "evaluation" },
                { title: "Competencia", dataKey: "competence" },
                { title: "Criterio", dataKey: "criterion" },
                { title: "Nota", dataKey: "grade" },
                { title: "Estado", dataKey: "status" }
            ];
            
            const data = [];
            const displayFormat = document.querySelector('input[name="groupDisplayFormat"]:checked').value;
            
            students.forEach(student => {
                let studentDisplay = '';
                
                switch (displayFormat) {
                    case 'id':
                        studentDisplay = student.id;
                        break;
                    case 'name':
                        studentDisplay = student.name;
                        break;
                    default:
                        studentDisplay = `${student.id} - ${student.name}`;
                }
                
                associations.forEach(assoc => {
                    const evaluation = student.evaluations[assoc.evaluation] || 0;
                    const isApproved = evaluation >= minGrade;
                    
                    data.push({
                        student: studentDisplay,
                        evaluation: assoc.evaluation,
                        competence: assoc.competence,
                        criterion: assoc.criterion,
                        grade: evaluation.toFixed(2),
                        status: isApproved ? 'Aprobado' : 'No aprobado'
                    });
                });
            });
            
            // Aplicar filtros si existen
            const condition = document.getElementById('groupFilterCondition').value;
            const min = parseFloat(document.getElementById('groupFilterMinGrade').value);
            const max = parseFloat(document.getElementById('groupFilterMaxGrade').value);
            const value = parseFloat(document.getElementById('groupFilterValue').value);
            
            const filteredData = data.filter(row => {
                const grade = parseFloat(row.grade);
                
                switch (condition) {
                    case 'between':
                        if (!isNaN(min) && grade < min) return false;
                        if (!isNaN(max) && grade > max) return false;
                        return true;
                    case 'less':
                        if (!isNaN(value) && grade > value) return false;
                        return true;
                    case 'greater':
                        if (!isNaN(value) && grade < value) return false;
                        return true;
                    default:
                        return true;
                }
            });
            
            let startY = margin + 55;
            
            doc.autoTable({
                startY: startY,
                head: [headers.map(h => h.title)],
                body: filteredData.map(row => headers.map(h => row[h.dataKey])),
                margin: { left: margin, right: margin },
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    overflow: 'linebreak'
                },
                headStyles: {
                    fillColor: [52, 152, 219],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [242, 242, 242]
                },
                columnStyles: {
                    0: { cellWidth: 30 },
                    4: { cellWidth: 15 },
                    5: { cellWidth: 15 }
                },
                pageBreak: 'auto'
            });
            
            // Mensaje motivacional
            let lastY = doc.lastAutoTable.finalY + 10;
            
            if (lastY > pageHeight - 30) {
                doc.addPage();
                lastY = margin;
            }
            
            doc.setFontSize(12);
            doc.text('Recomendaciones para el grupo:', margin, lastY);
            
            doc.setFontSize(10);
            if (approvalRate >= 80) {
                doc.text('¡Excelente trabajo! La mayoría del grupo ha aprobado las competencias.', margin + 5, lastY + 10);
                doc.text('Continúen con el buen rendimiento y mantengan el ritmo de aprendizaje.', margin + 5, lastY + 15);
            } else if (approvalRate >= 50) {
                doc.text('El grupo está mostrando un rendimiento aceptable, pero hay margen de mejora.', margin + 5, lastY + 10);
                doc.text('Se recomienda reforzar los temas con mayor dificultad y fomentar el estudio grupal.', margin + 5, lastY + 15);
            } else {
                const recommendations = [
                    'El grupo necesita mejorar su rendimiento académico.',
                    'Recomendaciones:',
                    '• Organizar sesiones de refuerzo para los temas con mayor dificultad.',
                    '• Fomentar el estudio colaborativo y los grupos de trabajo.',
                    '• Revisar las estrategias de enseñanza para adaptarlas a las necesidades del grupo.',
                    '• Proporcionar retroalimentación detallada sobre los aspectos a mejorar.'
                ];
                
                recommendations.forEach((rec, i) => {
                    if (lastY + 15 + (i * 5) > pageHeight - 10) {
                        doc.addPage();
                        lastY = margin;
                    }
                    doc.text(rec, margin + 5, lastY + 10 + (i * 5));
                });
            }
            
            // Guardar PDF
            doc.save('Reporte_Grupal.pdf');
        }
        
        // Función para mostrar mensajes
        function showMessage(message, type) {
            const messageDiv = document.getElementById('associationMessage');
            messageDiv.textContent = message;
            messageDiv.className = `message-box message-${type}`;
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>